<!DOCTYPE html>
<!--
    DP-Display

    By Gary Wolfe
    Version: 1.1
    Last edit: 4/3/2023
    Original creation date: 4/1/2023
    License: Free to use by former users of DPReview.com to view their data.  No guarantee of accuracy or suitability is given.

    This local web page allows you to drag-and-drop your DPReview message dump (if you requested your data from DPR)
    and present the messages in a more human-readable format.

    At the present, more work is needed to correctly format the data.

    How to use:

    - Drag and drop your forum-posts.json file into the box
    - From the list of displayed topics, choose which batch of messages you want displayed
      (It may take several seconds for it to unpack the data)
    - Scroll down or use the search to see your messages and quoted info.

    Limitations:

    - Currently, I don't clear out the previous data, so if you keep clicking on topics, it just appends to the bottom of 
      the document, which will get very large.
    - There's not enough formatting.  Quoted data is not indented or colored, and the whole page is not styled.

-->
<head>
    <title>DP-Display</title>
    <style>
      #drop-area {
        border: 5px dashed rgb(0, 225, 255);
        width: 440px;
        height: 272px;
      }
    </style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>

  <body>
    <h1>DP-Display</h1>
    Drag-and-drop your dpreview-information-request.zip or extracted forums-post.json file here!
	  <p>Only forum-posts.json is displayed.
	  <div id="drop-area"></div
	or select it here:
    <p><input type="file" id="file-selector">
	<div id="log"></div>
<script>

const dropArea = document.getElementById('drop-area');

//For info on how to drag-and-drop and load files:  https://web.dev/read-files/

dropArea.addEventListener('dragover', (event) => {
  event.stopPropagation();
  event.preventDefault();
  
  event.dataTransfer.dropEffect = 'copy';
});

dropArea.addEventListener('drop', (event) => {
  event.stopPropagation();
  event.preventDefault();
  const fileList = event.dataTransfer.files;
  console.log(fileList);

  const file=fileList[0];
  handleFile(file);
});

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    processFile();
  }
});

const fileSelector = document.getElementById('file-selector');
fileSelector.addEventListener('change', (event) => {
    const fileList = event.target.files;
    console.log(fileList);

    const file=fileList[0];
	handleFile(file);
});

var distinctValues;
var fileContents = "";
var forumIndex;

const logg = document.getElementById("log");

async function handleFile(file) {
	if( file.type === "application/zip" || file.type === "application/x-zip-compressed" ) {
		try {
			const zipContents = await JSZip.loadAsync(file);
			fileContents = await zipContents.file("data/forum-posts.json").async("string");
			processFile();
		} catch (e) {
			logg.innerHTML="ERROR " + e;
		}
	} else if( file.type === "application/json" ) {
		const reader = new FileReader();
		reader.addEventListener('load', event => {
			fileContents = event.target.result;
			processFile();
		});
		reader.readAsText(file);
	} else {
		logg.innerHTML = "<p><b>not a json or zip file";
		myDiv.innerHTML = "";
		forumDiv.innerHTML = "";
	}
	forumIndex = undefined;
}

const myDiv = document.createElement('div');
myDiv.setAttribute('id','topicList');
document.body.appendChild(myDiv);

const forumDiv = document.createElement('div');
document.body.appendChild(forumDiv);

const htmlList = document.createElement('ul');

function processFile() {
	myDiv.innerHTML = "";
	htmlList.innerHTML = "";
	forumDiv.innerHTML = "";

    const data = JSON.parse(fileContents);
    const forumPosts = data.forumPosts;

    const distinctValues = [...new Set(forumPosts.map(item => item.forum))];
    //TODO: if #topicList exists, remove?  Or, perhaps after loading, remove #drop-area.
    myDiv.appendChild(htmlList);
    var index=0;
    distinctValues.forEach(key => {
    const li = document.createElement('li');
    li.setAttribute("id", "topic_"+index++);
    const link = document.createElement('a');
    link.textContent = key;
    link.setAttribute("href","#");
    li.appendChild(link);
    htmlList.appendChild(li);
    });

	// redisplay if tab regained focus (visibility changed event)
	expandForum(forumIndex);


    $(function() {
        $("#topicList ul li").click(function() {
          //alert(this.id);
            
          // clear out contents of previous list
          forumDiv.innerHTML = "";

          forumIndex = this.id.substring("topic_".length);

		  // display the selected forum
          expandForum(forumIndex);
        });
    });

	function expandForum(index) {
		  if(!index) return;

          const subHeader = document.createElement('h2');
          subHeader.innerText = distinctValues[index];
          forumDiv.appendChild(subHeader);
          forumPosts.filter(p => p.forum==distinctValues[index]).forEach(post => printPost(post, forumDiv));

          //switch img urls where a better attribute is present.  Check for current-owner, else it'll load other's images,
          //potentially transferring a lot more data.
          const images = document.images;
          for (let i = 0; i < images.length; i++) {
              const img = images[i];
              //If img is inside a quote class, assume it's not ours.  Skip them.  
              //Class-quote is used in older DPR messages, while blockquote is used in newer messages.
              if (img.parentElement.parentElement.parentElement.className != 'quote' && 
                img.parentElement.parentElement.parentElement.localName != 'blockquote') {
                if (img.dataset.dprClickthroughUrl != undefined) {
                  img.src = img.dataset.dprClickthroughUrl;
				  img.width = "560";
				  img.style.display = "block";
                }
                else 
                if (img.dataset.dprUrl != undefined) {
                  //use the link to the external site
                  img.src = img.dataset.dprUrl;
                }

                //Remaining photos will attempt to load using img.src.
                //A lot of the URLs need to be rebuilt with a different path plus a numeric user ID, 
                //but the format isn't obvious.
			}
          }
	}

    function printPost(post, outerDiv) {
      const myDiv = document.createElement('div');
      //Setting innerHTML isn't standard, but should work in most browsers anyway.
      myDiv.innerHTML = '<hr/>' +post.subject + '<br/>' + post.postDate  + '<br/>' + post.messageTextHtml;
      outerDiv.appendChild(myDiv);

		// fix image source
		const postId = post.url.split('/').pop();
		const imgs = myDiv.getElementsByTagName("img");
		for( const img of imgs ) {
			if (img.src.includes("amazonaws.com")) {


        //In theory, if it's just a mirror, the number shouldn't matter, but...
        let serverNumber = 1;
        if (img.dataset.dprSrcType=='f') {
          serverNumber=2;
        }
        else if (img.dataset.dprSrcType=='g') {
          serverNumber=3;
        }

				const dprPostId = img.dataset.dprPostId ? img.dataset.dprPostId : postId;

        let postPath ="";
        if (img.dataset.dprFileId != undefined) {
          postPath = `/files/p/TS560x560~forums/${dprPostId}/${img.dataset.dprFileId}`;
        }
        else {
          postPath = `${img.dataset.mceSrc}`; //this one includes "/files/g/TS...."
        }
        //could also use "dprLargeImageUrl", if exists.

        //img.src = `https://${serverNumber}.img-dpreview.com/files/p/TS560x560~forums/${dprPostId}/${img.dataset.dprFileId}`;

				img.src = `https://${serverNumber}.img-dpreview.com${postPath}`;
				img.style.display = "block";

				const fullSizeLink = document.createElement("a");
	 			fullSizeLink.textContent = "Original size";
        if (img.dataset.dprClickthroughUrl!=undefined) {
          fullSizeLink.setAttribute("href", `${img.dataset.dprClickthroughUrl}`);
        }
        else {
          fullSizeLink.setAttribute("href", `https://${serverNumber}.img-dpreview.com/files/p/E~forums/${dprPostId}/${img.dataset.dprFileId}`);
        }
				fullSizeLink.setAttribute("target", "_blank");
				fullSizeLink.style.display = "block";
				img.parentElement.appendChild(fullSizeLink);
			}
		}

      const link = document.createElement('a');
      link.textContent = post.url;
      link.setAttribute("href",post.url);
		link.setAttribute("target","dplost");
      outerDiv.appendChild(link);
    }
}

</script>

    
</body>
